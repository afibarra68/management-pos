<div class="registrar-salida-container">
  <!-- Contenido Principal -->
  <div class="main-content">
    <div class="form-header">
      <h1>Registrar Salida</h1>
      <p class="subtitle">Busque el vehículo por placa para procesar su salida</p>
      @if (currentShift) {
      <p class="shift-info"><strong>Turno:</strong> {{ getShiftDisplayText() }}</p>
      }
    </div>

    <form [formGroup]="form" (ngSubmit)="buscarVehiculo()" class="form-container">
      <!-- Bloque: Búsqueda de Vehículo -->
      <div class="form-block">
        <div class="block-header">
          <span class="block-title">Búsqueda de Vehículo</span>
        </div>
        <div class="block-content">
          <div class="form-group">
            <label for="vehiclePlate">Placa del Vehículo *</label>
            <input id="vehiclePlate" type="text" formControlName="vehiclePlate"
              [class.invalid]="form.get('vehiclePlate')?.invalid && form.get('vehiclePlate')?.touched"
              (input)="form.patchValue({vehiclePlate: form.value.vehiclePlate.toUpperCase()})" maxlength="8"
              placeholder="ABC123">
            @if (form.get('vehiclePlate')?.invalid && form.get('vehiclePlate')?.touched) {
            <small class="error-text">
              @if (form.get('vehiclePlate')?.errors?.['required']) {
              <span>La placa es requerida</span>
              }
              @if (form.get('vehiclePlate')?.errors?.['minlength']) {
              <span>La placa debe tener al menos 3 caracteres</span>
              }
              @if (form.get('vehiclePlate')?.errors?.['maxlength']) {
              <span>La placa no puede tener más de 8 caracteres</span>
              }
            </small>
            }
          </div>
        </div>
      </div>

      <!-- Acciones -->
      <div class="form-actions">
        <button type="submit" class="btn-primary" [disabled]="form.invalid || buscando">
          Buscar Vehículo
        </button>
      </div>
    </form>
  </div>

  <!-- Modal de Confirmación -->
  @if (showModal && vehiculoEncontrado) {
  <div class="modal-overlay" (click)="cerrarModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Vehículo: {{ vehiculoEncontrado.vehiclePlate }}</h2>
        <button type="button" class="btn-close" (click)="cerrarModal()">×</button>
      </div>

      <div class="modal-body">
        <!-- Bloque: Información del Vehículo -->
        <div class="form-block">
          <div class="block-header">
            <span class="block-title">Información del Vehículo</span>
          </div>
          <div class="block-content">
            <div class="info-grid">
              <div class="info-row">
                <label>Placa:</label>
                <span>{{ vehiculoEncontrado.vehiclePlate }}</span>
              </div>
              <div class="info-row">
                <label>Fecha Entrada:</label>
                <span>{{ vehiculoEncontrado.startDay }}</span>
              </div>
              <div class="info-row">
                <label>Hora Entrada:</label>
                <span>{{ vehiculoEncontrado.startTime }}</span>
              </div>
              @if (vehiculoEncontrado.tipoVehiculo || vehiculoEncontrado.basicVehicleType) {
              <div class="info-row">
                <label>Tipo de Vehículo:</label>
                <span>{{ getTipoVehiculoDisplay(vehiculoEncontrado.tipoVehiculo || vehiculoEncontrado.basicVehicleType)
                  }}</span>
              </div>
              }
              <div class="info-row">
                <label>Estado:</label>
                <span>{{ getStatusDisplay(vehiculoEncontrado.status) }}</span>
              </div>
              @if (vehiculoEncontrado.notes) {
              <div class="info-row">
                <label>Notas:</label>
                <span>{{ vehiculoEncontrado.notes }}</span>
              </div>
              }
            </div>
          </div>
        </div>

        <!-- Bloque: Notas de Caja -->
        <div class="form-block">
          <div class="block-header">
            <span class="block-title">Notas de Caja</span>
            <span class="block-subtitle">Opcional</span>
          </div>
          <div class="block-content">
            <div class="form-group">
              <label for="exitNotes">Notas de Caja</label>
              <textarea id="exitNotes" [(ngModel)]="exitNotes" rows="2"
                placeholder="Agregue cualquier nota adicional que aparecerá en el ticket impreso...">
                </textarea>
              <small class="help-text">Esta información aparecerá en el campo 'notes' del ticket impreso</small>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="cancelar()" [disabled]="loading">
          Cancelar
        </button>
        <button type="button" class="btn-primary" (click)="procesarSalida()" [disabled]="loading">
          Procesar Salida
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Modal solicitar impresión (igual que en registrar ingreso) -->
  @if (showTicketPreview && pendingBuildTicket) {
  <div class="modal-overlay" (click)="cancelPrintTicket()">
    <div class="modal-content modal-print" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Solicitar impresión</h2>
        <button type="button" class="btn-close" (click)="cancelPrintTicket()">×</button>
      </div>
      <div class="modal-body">
        @if (pendingTotalAmount != null) {
        <div class="total-a-pagar-block">
          <span class="total-a-pagar-label">Total a pagar</span>
          <span class="total-a-pagar-monto">$ {{ pendingTotalAmount | number:'1.0-0' }}</span>
        </div>
        }
        <div class="form-block">
          <div class="block-header">
            <span class="block-title">Vista previa del ticket de salida</span>
          </div>
          <div class="block-content">
            <div class="tirilla-wrapper">
              <div class="tirilla-strip">
                <span class="tirilla-cut tirilla-cut-top" aria-hidden="true"></span>
                <pre class="tirilla-text">{{ getPreviewText(pendingBuildTicket) }}</pre>
                <span class="tirilla-cut tirilla-cut-bottom" aria-hidden="true"></span>
              </div>
            </div>
            <p class="ticket-preview-question">¿Desea imprimir la tirilla?</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="cancelPrintTicket()">No imprimir</button>
        <button type="button" class="btn-primary" (click)="confirmPrintTicket()">Imprimir tirilla</button>
      </div>
    </div>
  </div>
  }
</div>