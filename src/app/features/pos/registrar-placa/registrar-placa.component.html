<div class="registrar-placa-container">
  <!-- Contenido Principal -->
  <div class="main-content">
    <div class="form-header">
      <h1>Registrar Ingreso de Vehículo</h1>
      @if (currentShift) {
      <p class="shift-info"><strong>Turno:</strong> {{ getShiftDisplayText() }}</p>
      }
    </div>

    <form [formGroup]="form" (ngSubmit)="submit()" class="form-container">
      <!-- Bloque: Información del Vehículo -->
      <div class="form-block">
        <div class="block-header">
          <span class="block-title">Información del Vehículo</span>
        </div>
        <div class="block-content">
          <div class="form-row">
            <div class="form-group">
              <label for="vehiclePlate">Placa del Vehículo *</label>
              <input id="vehiclePlate" type="text" formControlName="vehiclePlate"
                [class.invalid]="form.get('vehiclePlate')?.invalid && form.get('vehiclePlate')?.touched"
                (click)="openPlateFinder(); $event.preventDefault()"
                (focus)="openPlateFinder(); $event.preventDefault()" readonly placeholder="ABC123 - Click para ingresar"
                style="cursor: pointer;">
              @if (form.get('vehiclePlate')?.invalid && form.get('vehiclePlate')?.touched) {
              <small class="error-text">
                @if (form.get('vehiclePlate')?.errors?.['required']) {
                <span>La placa es requerida</span>
                }
                @if (form.get('vehiclePlate')?.errors?.['minlength']) {
                <span>La placa debe tener al menos 3 caracteres</span>
                }
                @if (form.get('vehiclePlate')?.errors?.['maxlength']) {
                <span>La placa no puede tener más de 6 caracteres</span>
                }
              </small>
              }
            </div>

            @if (params) {
            @if (easyMode) {
            <div class="form-group">
              <label for="basicVehicleType">Tipo de Vehículo *</label>
              <select id="basicVehicleType" formControlName="basicVehicleType"
                [class.invalid]="form.get('basicVehicleType')?.invalid && form.get('basicVehicleType')?.touched">
                <option value="">Seleccione...</option>
                @for (option of basicVehicleTypeOptions; track option.value) {
                <option [value]="getOptionValue(option.value)">{{ option.label }}</option>
                }
              </select>
              @if (form.get('basicVehicleType')?.invalid && form.get('basicVehicleType')?.touched) {
              <small class="error-text">El tipo de vehículo es requerido</small>
              }
            </div>
            } @else {
            <div class="form-group">
              <label for="tipoVehiculo">Tipo de Vehículo *</label>
              <select id="tipoVehiculo" formControlName="tipoVehiculo"
                [class.invalid]="form.get('tipoVehiculo')?.invalid && form.get('tipoVehiculo')?.touched"
                (change)="onFieldComplete('tipoVehiculo')" #tipoVehiculoSelect>
                <option value="">Seleccione...</option>
                @for (option of tipoVehiculoOptions; track option.value) {
                <option [value]="getOptionValue(option.value)">{{ option.label }}</option>
                }
              </select>
              @if (form.get('tipoVehiculo')?.invalid && form.get('tipoVehiculo')?.touched) {
              <small class="error-text">El tipo de vehículo es requerido</small>
              }
            </div>
            }
            }
          </div>
        </div>
      </div>

      <!-- Bloque: Notas Adicionales -->
      <div class="form-block">
        <div class="block-header">
          <span class="block-title">Notas Adicionales</span>
          <span class="block-subtitle">Opcional</span>
        </div>
        <div class="block-content">
          <div class="form-group">
            <label for="notes">Notas</label>
            <textarea id="notes" formControlName="notes" rows="2" (input)="onFieldComplete('notes')"
              placeholder="Agregue cualquier nota adicional sobre el ingreso del vehículo...">
            </textarea>
            <small class="help-text">Información adicional sobre el ingreso del vehículo</small>
          </div>
        </div>
      </div>

      <!-- Acciones -->
      <div class="form-actions">
        <button type="submit" class="btn-primary" [disabled]="form.invalid || loading || loadingParams || !params">
          Registrar Placa
        </button>
        <button type="button" class="btn-secondary" (click)="form.reset({
            vehiclePlate: '',
            tipoVehiculo: '',
            basicVehicleType: '',
            notes: ''
          })" [disabled]="loading || loadingParams">
          Limpiar
        </button>
      </div>
    </form>
  </div>

  <!-- Modal estilo Finder para entrada de placa -->
  @if (showPlateFinder) {
  <div class="finder-overlay" (click)="closePlateFinder()">
    <div class="finder-modal" (click)="$event.stopPropagation()">
      <div class="finder-body">
        <div class="finder-input-wrapper">
          <input type="text" class="finder-input" [(ngModel)]="finderPlateValue" (input)="onFinderInput($event)"
            (keydown.enter)="confirmPlate()" (keydown.escape)="closePlateFinder()" maxlength="6" placeholder="ABC123"
            #finderInput>
          <div class="finder-hint">
            <span>Presione Enter para confirmar o Escape para cancelar</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Modal solicitar impresión (mismo patrón que registrar-salida) -->
  @if (showTicketPreview && pendingBuildTicket) {
  <div class="modal-overlay" (click)="cancelPrintTicket()">
    <div class="modal-content modal-print" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Solicitar impresión</h2>
        <button type="button" class="btn-close" (click)="cancelPrintTicket()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-block">
          <div class="block-header">
            <span class="block-title">Vista previa del ticket de ingreso</span>
          </div>
          <div class="block-content">
            <div class="tirilla-wrapper">
              <div class="tirilla-strip">
                <span class="tirilla-cut tirilla-cut-top" aria-hidden="true"></span>
                <pre class="tirilla-text">{{ getPreviewText(pendingBuildTicket) }}</pre>
                <span class="tirilla-cut tirilla-cut-bottom" aria-hidden="true"></span>
              </div>
            </div>
            <p class="ticket-preview-question">¿Desea imprimir la tirilla?</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="cancelPrintTicket()">No imprimir</button>
        <button type="button" class="btn-primary" (click)="confirmPrintTicket()">Imprimir tirilla</button>
      </div>
    </div>
  </div>
  }
</div>