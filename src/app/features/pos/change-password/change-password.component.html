<div class="change-password-wrapper">
  <div class="change-password-container">
    <p-card class="change-password-card">
      <ng-template pTemplate="header">
        <div class="change-password-header">
          <h1>Cambiar Contraseña</h1>
          @if (mustChange) {
          <p class="change-password-subtitle">Por seguridad, debes actualizar tu contraseña antes de continuar</p>
          } @else {
          <p class="change-password-subtitle">Por seguridad, actualiza tu contraseña</p>
          }
        </div>
      </ng-template>

      <form [formGroup]="form" (ngSubmit)="submit()" class="change-password-form">
        @if (success) {
        <p-message severity="success" text="Contraseña cambiada exitosamente. Redirigiendo..."
          styleClass="change-password-success">
        </p-message>
        }

        <div class="password-requirements">
          <p><strong>Requisitos de contraseña:</strong></p>
          <ul>
            <li>Mínimo 8 caracteres</li>
            <li>Al menos una letra mayúscula</li>
            <li>Al menos una letra minúscula</li>
            <li>Al menos un dígito</li>
            <li>Al menos un carácter especial</li>
          </ul>
        </div>

        <div class="form-field">
          <label for="username" class="field-label">
            Usuario
          </label>
          <span class="p-input-icon-left" style="width: 100%;">
            <input id="username" type="text" pInputText formControlName="username" placeholder="Ingresa tu usuario"
              [readonly]="!!username"
              [class.ng-invalid]="form.get('username')?.invalid && form.get('username')?.touched"
              style="width: 100%;" />
          </span>
          @if (form.get('username')?.invalid && form.get('username')?.touched) {
          <small class="p-error">
            El usuario es requerido
          </small>
          }
        </div>

        <div class="form-field">
          <label for="currentPassword" class="field-label">
            Contraseña Actual
          </label>
          <span class="p-input-icon-left" style="width: 100%;">
            <p-password id="currentPassword" formControlName="currentPassword"
              placeholder="Ingresa tu contraseña actual" [toggleMask]="true" [feedback]="false"
              [class.ng-invalid]="form.get('currentPassword')?.invalid && form.get('currentPassword')?.touched"
              styleClass="full-width" inputStyleClass="full-width">
            </p-password>
          </span>
          @if (form.get('currentPassword')?.invalid && form.get('currentPassword')?.touched) {
          <small class="p-error">
            La contraseña actual es requerida
          </small>
          }
        </div>

        <div class="form-field">
          <label for="newPassword" class="field-label">
            Nueva Contraseña
          </label>
          <span class="p-input-icon-left" style="width: 100%;">
            <p-password id="newPassword" formControlName="newPassword" placeholder="Ingresa tu nueva contraseña"
              [toggleMask]="true" [feedback]="true"
              [class.ng-invalid]="form.get('newPassword')?.invalid && form.get('newPassword')?.touched"
              styleClass="full-width" inputStyleClass="full-width">
            </p-password>
          </span>
          @if (form.get('newPassword')?.invalid && form.get('newPassword')?.touched) {
          <small class="p-error">
            @if (form.get('newPassword')?.errors?.['required']) {
            <span>La nueva contraseña es requerida</span>
            }
            @if (form.get('newPassword')?.errors?.['minlength']) {
            <span>La contraseña debe tener al menos 8 caracteres</span>
            }
          </small>
          }
        </div>

        <div class="form-field">
          <label for="confirmPassword" class="field-label">
            Confirmar Nueva Contraseña
          </label>
          <span class="p-input-icon-left" style="width: 100%;">
            <p-password id="confirmPassword" formControlName="confirmPassword"
              placeholder="Confirma tu nueva contraseña" [toggleMask]="true" [feedback]="false"
              [class.ng-invalid]="(form.get('confirmPassword')?.invalid || form.errors?.['passwordMismatch']) && form.get('confirmPassword')?.touched"
              styleClass="full-width" inputStyleClass="full-width">
            </p-password>
          </span>
          @if (form.get('confirmPassword')?.invalid && form.get('confirmPassword')?.touched) {
          <small class="p-error">
            @if (form.get('confirmPassword')?.errors?.['required']) {
            <span>Debes confirmar la contraseña</span>
            }
          </small>
          }
          @if (form.errors?.['passwordMismatch'] && form.get('confirmPassword')?.touched) {
          <small class="p-error">
            Las contraseñas no coinciden
          </small>
          }
        </div>

        <div class="form-actions">
          @if (!mustChange) {
          <p-button type="button" label="Cancelar" icon="pi pi-times" (onClick)="cancel()"
            [disabled]="loading || success" styleClass="p-button-secondary">
          </p-button>
          }
          <p-button type="submit" label="Cambiar Contraseña" icon="pi pi-key"
            [disabled]="form.invalid || loading || success" [loading]="loading" styleClass="change-password-button">
          </p-button>
        </div>
      </form>
    </p-card>
  </div>
</div>