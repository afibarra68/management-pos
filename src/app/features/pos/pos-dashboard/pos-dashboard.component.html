<div class="pos-dashboard-container">
  <div class="header">
    <h1>Punto de Venta</h1>
    @if (isDashboardView()) {
    <p class="subtitle">Dashboard del día de hoy</p>
    }
  </div>

  <!-- Dashboard View -->
  @if (isDashboardView()) {
  <div class="dashboard-content">
    <!-- Error State -->
    @if (hasError()) {
    <div class="error-state">
      <i class="pi pi-exclamation-triangle" style="font-size: 2rem; color: var(--red-500)"></i>
      <p>{{ error() }}</p>
      <p-button label="Reintentar" icon="pi pi-refresh" (onClick)="loadStats()"></p-button>
    </div>
    }

    <!-- Stats Cards (mostrar siempre, incluso si está cargando con datos previos) -->
    @if (!hasError()) {
    <div class="stats-cards">
      <p-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon total">
            <i class="pi pi-chart-line"></i>
          </div>
          <div class="stat-info">
            <h3 class="stat-label">Total Operaciones</h3>
            <p class="stat-value">{{ stats()?.totalTransactions ?? 0 }}</p>
          </div>
        </div>
      </p-card>

      <p-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon amount">
            <i class="pi pi-money-bill"></i>
          </div>
          <div class="stat-info">
            <h3 class="stat-label">Total en Caja</h3>
            <p class="stat-value">
              {{ formatCurrency(totalCash(), 'COP') }}
            </p>
          </div>
        </div>
      </p-card>
    </div>
    }

    <!-- Mapa de Puestos -->
    <div class="parking-map-section">
      <app-parking-map></app-parking-map>
    </div>

    <!-- Visualizador de Caja -->
    <div class="cash-register-section">
      <app-cash-register-view></app-cash-register-view>
    </div>

    <!-- Transactions Table (mostrar si hay datos) -->
    @if (hasStats() && !hasError()) {
    <div class="transactions-section">
      <div class="header">
        <h2>Transacciones del Día</h2>
      </div>
      <p-card class="summary-card">
        @if (stats(); as currentStats) {
        <p-table [value]="currentStats.transactions" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} transacciones"
          styleClass="p-datatable-sm">
          <ng-template pTemplate="header">
            <tr>
              <th>Hora</th>
              <th>Tiempo Estacionado</th>
              <th>Monto</th>
              <th>Vendedor</th>
              <th>Acciones</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-transaction>
            <tr>
              <td>{{ formatDate(transaction.operationDate) }}</td>
              <td>{{ transaction.timeElapsed ?? 'N/A' }}</td>
              <td>{{ formatCurrency(transaction.totalAmount, transaction.currency) }}</td>
              <td>{{ transaction.sellerName ?? 'N/A' }}</td>
              <td>
                <p-button icon="pi pi-print" label="Reimprimir" [outlined]="true" size="small"
                  (onClick)="reimprimirTicket(transaction.closedTransactionId)" styleClass="p-button-sm">
                </p-button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center">No hay transacciones registradas hoy</td>
            </tr>
          </ng-template>
        </p-table>
        }
      </p-card>
    </div>
    }
  </div>
  }

  <!-- Actions Buttons (shown when not in dashboard view) -->
  @if (!isDashboardView()) {
  <div class="actions-buttons">
    <p-button label="Volver al Dashboard" icon="pi pi-arrow-left" (onClick)="showDashboard()"
      styleClass="p-button-secondary">
    </p-button>
  </div>
  }

  <!-- Content Area for Forms -->
  @if (!isDashboardView()) {
  <div class="content-area">
    @if (currentView() === 'ingresar') {
    <app-registrar-placa></app-registrar-placa>
    }
    @if (currentView() === 'salida') {
    <app-registrar-salida></app-registrar-salida>
    }
  </div>
  }
</div>